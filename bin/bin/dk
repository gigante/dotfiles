#!/bin/bash

function help() {
    cat <<END
Docker aliases
Usage: dk <command> [<args>]

Some useful dk commands are:
   ls     list images
   ps     list active containers
   sh     shell into <img>
   bind   create volume with current dir and sh <img>
   clean  cleanup unused resources
END
    exit 1
}

function sh() {
    img=$2
    command=$3
    if [[ -z "$command" ]]; then
        docker run -it --rm $img '/bin/sh'
    else
        docker run -it --rm $img "${@:3}"
    fi
}

function bind() {
    img=$2
    dir=$(basename "$PWD")
    docker run -it --rm -v $(pwd):/mnt/$dir -w /mnt/$dir $img /bin/sh
}

function clean() {
    echo '-> removing <none> images'
    noneimgs=$(docker images -a | grep "^<none>" | awk '{ print $3 }')
    [[ ! -z "$noneimgs" ]] && echo docker rmi $noneimg

    echo '-> removing dangling images'
    dangling=$(docker images -f "dangling=true" -q)
    [[ ! -z "$dangling" ]] && docker rmi $dangling

    echo '-> removing stopped containers'
    stopped=$(docker ps -a -q)
    [[ ! -z "$stopped" ]] && docker rm $stopped

    echo '-> removing unused networks'
    docker network prune -f

    echo '-> removing unused local volumes'
    docker volume prune -f
}

function main() {
    command=$1
    [[ -z "$command" ]] && help && exit 1

    case "$command" in
    ls) docker images --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}" "${@:2}" | tail -n +2 | sort -d ;;
    ps) docker ps --format "table {{.Names}}\t{{.Image}}:{{.ID}}\t{{.Status}}" "${@:2}" | tail -n +2 | sort -d ;;
    sh) sh "$@" ;;
    bind) bind "$@" ;;
    clean) clean ;;
    *) docker "$@" ;;
    esac
}

main "$@"
